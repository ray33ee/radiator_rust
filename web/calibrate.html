<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radiator Controller • Calibrate</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" href="/favicon.png" type="image/png">
  <style>
    /* Settings-style layout (for calibrate page too) */
.settings {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
  max-width: 860px;
}

.group {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.group > h3 {
  margin: 0;
  padding: 12px 14px;
  font-size: 14px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  letter-spacing: .02em;
}

.item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 14px;
}

.item + .item { border-top: 1px solid var(--border); }

.item .left { min-width: 0; }
.item .left .label { font-size: 12px; color: var(--muted); }
.item .left .value { font-size: 16px; font-weight: 600; margin-top: 2px; }

.item .right {
  display: inline-flex;
  gap: 8px;
  align-items: center;
}

.item .right form { margin: 0; }

@media (max-width: 640px) {
  .item { flex-direction: column; align-items: stretch; }
  .item .right { justify-content: flex-end; }
}

/* Inputs inside settings items */
.item input[type="number"] {
  flex: 1 1 auto;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font: inherit;
  min-width: 60px;
}

.item input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

/* Toast / inline notice */
.toast {
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%);
  max-width: min(560px, 92vw);
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-left: 4px solid var(--accent);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 12px 14px;
  font-size: 14px;
  line-height: 1.3;
  z-index: 9999;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  animation: toast-in 150ms ease-out;
}

.toast .icon {
  flex: 0 0 auto;
  margin-top: 1px;
  width: 18px;
  height: 18px;
  opacity: .85;
}

.toast .msg {
  flex: 1 1 auto;
  min-width: 0;
}

.toast .close {
  appearance: none;
  border: none;
  background: transparent;
  color: inherit;
  font: inherit;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 8px;
  opacity: .7;
}
.toast .close:hover { opacity: 1; }

@keyframes toast-in {
  from { transform: translateX(-50%) translateY(8px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0);  opacity: 1; }
}


  </style>
</head>
<body>
  <div class="app">
    <!-- Mobile menu toggle -->
    <input id="menu" type="checkbox" class="menu-toggle" />

    <header class="header">
      <label for="menu" class="hamburger" aria-label="Open navigation"><span></span></label>
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>Radiator Controller</div>
      </div>
      <div class="right">
        <span class="label">Calibrate</span>
      </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="nav">
        <div class="nav-group">
          <div class="nav-title">Main</div>
          <a href="/">Home</a>
        </div>

        <div class="nav-group">
          <div class="nav-title">Controls</div>
          <a href="/thermostat">Thermostat</a>
          <a href="/calibrate">Schedule</a>
          <div class="sub">
            <a href="/summer">Summer</a>
            <a href="/winter">Winter</a>
            <a href="/brightness">Brightness</a>
          </div>
          <a class="active" href="/calibrate">Calibrate</a>
        </div>

        <div class="nav-group">
          <div class="nav-title">System</div>
          <a href="/network">Network</a>
          <a href="/settings">Settings</a>
        </div>
      </div>
    </nav>

    <!-- Backdrop for mobile menu -->
    <label for="menu" class="backdrop" aria-hidden="true"></label>

    <!-- Main -->
    <main class="main">
      <div class="settings">
        <section class="group">
          <h3>Calibration</h3>

          <!-- Calibrate mode -->
          <div class="item">
            <div class="left">
              <div class="label">Calibrate mode</div>
              <div class="value">Enable manual motor control</div>
            </div>
            <div class="right">
              <form id="cal-mode-form">
                <button class="btn btn-primary" type="submit">Enter Calibrate Mode</button>
              </form>
            </div>
          </div>

          <!-- Max position (label) -->
          <div class="item">
            <div class="left">
              <div class="label">Max position</div>
              <div class="value" id="max-pos">{{0}}</div>
            </div>
            <div class="right"></div>
          </div>

          <!-- Lock status (label) -->
          <div class="item">
            <div class="left">
              <div class="label">Lock status</div>
              <div class="value" id="lock-status">{{1}}</div>
            </div>
            <div class="right"></div>
          </div>

          <!-- Current position (label) -->
          <div class="item">
            <div class="left">
              <div class="label">Current position</div>
              <div class="value" id="cur-pos">{{2}}</div>
            </div>
            <div class="right"></div>
          </div>

          <!-- Set max -->
          <div class="item">
            <div class="left">
              <div class="label">Set max (steps)</div>
              <div class="value">Define mechanical maximum</div>
            </div>
            <div class="right">
              <input type="number" id="set-max-input" min="1" max="1000" value="40" />
              <form id="set-max-form">
                <button class="btn btn-primary" type="submit">Set max</button>
              </form>
            </div>
          </div>

          <!-- Push / Pull -->
          <div class="item">
            <div class="left">
              <div class="label">Manual move</div>
              <div class="value">Jog motor to find limits</div>
            </div>
            <div class="right">
              <form id="push-form">
                <button class="btn btn-primary" type="submit">Calibrate Push</button>
              </form>
              <form id="pull-form">
                <button class="btn btn-primary" type="submit">Calibrate Pull</button>
              </form>
            </div>
          </div>

          <!-- Lock / Unlock+Zero -->
          <div class="item">
            <div class="left">
              <div class="label">Locking</div>
              <div class="value">Protect motor from undefined positions</div>
            </div>
            <div class="right">
              <form id="lock-form">
                <button class="btn btn-warn" type="submit">Lock</button>
              </form>
              <form id="unlock-zero-form">
                <button class="btn btn-danger" type="submit">Unlock &amp; Zero</button>
              </form>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    function showToast(message, {timeout = 2000} = {}) {
      // Remove an existing toast to avoid stacking
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'polite');

      // Simple inline SVG warning icon (inherits text color)
      const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      icon.setAttribute('viewBox', '0 0 24 24');
      icon.classList.add('icon');
      icon.innerHTML = '<path d="M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z"></path>';

      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = message;

      const close = document.createElement('button');
      close.className = 'close';
      close.type = 'button';
      close.setAttribute('aria-label', 'Dismiss');
      close.textContent = '×';
      close.addEventListener('click', () => toast.remove());

      toast.append(icon, msg, close);
      document.body.appendChild(toast);

      if (timeout > 0) {
        setTimeout(() => {
          // Fade-out (optional): just remove for simplicity
          toast.remove();
        }, timeout);
      }
    }
  </script>


  <script>



    // All requests are POSTs with query flags; page stays put.
    document.getElementById('cal-mode-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { await fetch('/calibrate?action=calibrate', { method: 'POST' }); } catch(e){}
    });

    document.getElementById('set-max-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const v = parseInt(document.getElementById('set-max-input').value, 10) || 0;
      try { 

        var res = await fetch('/calibrate?set_max=' + encodeURIComponent(v), { method: 'POST' }); 

        if (res.status == 403) {
          showToast('Must be in calibrate mode to change motor settings.');
          return;
        }

      } catch(e){ 

      }
    });

    document.getElementById('push-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { 
        var res = await fetch('/calibrate?push=7', { method: 'POST' });  

        if (res.status == 403) {
          showToast('Must be in calibrate mode to manually push motor.');
          return;
        }

      } catch(e){}
    });

    document.getElementById('pull-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { 
        var res = await fetch('/calibrate?pull=7', { method: 'POST' });  

        if (res.status == 403) {
          showToast('Must be in calibrate mode to manually pull motor.');
          return;
        }
      } catch(e){}
    });

    document.getElementById('lock-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { 
        var res = await fetch('/calibrate?action=lock', { method: 'POST' });  

        if (res.status == 403) {
          showToast('Must be in calibrate mode to lock motor.');
          return;
        }
      } catch(e){}
    });

    document.getElementById('unlock-zero-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { 
        var res = await fetch('/calibrate?action=unlock_zero', { method: 'POST' });  

        if (res.status == 403) {
          showToast('Must be in calibrate mode to unlock and zero motor.');
          return;
        }
      } catch(e){}
    });
  </script>
</body>
</html>
