<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radiator Controller • Network</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" href="/favicon.png" type="image/png">
  <style>
    /* Settings-style layout (for calibrate page too) */
.settings {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
  max-width: 860px;
}

.group {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.group > h3 {
  margin: 0;
  padding: 12px 14px;
  font-size: 14px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  letter-spacing: .02em;
}

.item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 14px;
}

.item + .item { border-top: 1px solid var(--border); }

.item .left { min-width: 0; }
.item .left .label { font-size: 12px; color: var(--muted); }
.item .left .value { font-size: 16px; font-weight: 600; margin-top: 2px; }

.item .right {
  display: inline-flex;
  gap: 8px;
  align-items: center;
}

.item .right form { margin: 0; }

@media (max-width: 640px) {
  .item { flex-direction: column; align-items: stretch; }
  .item .right { justify-content: flex-end; }
}

/* Inputs inside settings items */
.item input[type="number"],
.item input[type="text"] {
  flex: 1 1 auto;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font: inherit;
  min-width: 60px;
}

.item input[type="number"]:focus,
.item input[type="text"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

/* Disabled inputs clearly greyed */
.item input:disabled { opacity: 0.6; }

/* Buttons */
button {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font: inherit;
  cursor: pointer;
}
button.primary {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

/* Toggle switch (DHCP ↔ Static) */
.toggle-row {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  user-select: none;
}

.switch {
  position: relative;
  width: 52px;
  height: 28px;
  display: inline-block;
}
.switch input {
  position: absolute;
  opacity: 0;
  width: 0; height: 0;
}
.slider {
  position: absolute;
  inset: 0;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 999px;
  transition: transform 150ms ease, background 150ms ease, box-shadow 150ms ease;
  box-shadow: var(--shadow);
}
.slider::before {
  content: "";
  position: absolute;
  height: 22px; width: 22px;
  left: 3px; top: 50%;
  transform: translateY(-50%);
  background: var(--card);
  border-radius: 50%;
  transition: transform 150ms ease;
  box-shadow: 0 1px 2px rgba(0,0,0,.2);
}
.switch input:checked + .slider {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}
.switch input:checked + .slider::before {
  transform: translate(21px, -50%);
}

/* Small captions beside the switch */
.switch-label {
  font-size: 12px;
  color: var(--muted);
}
  </style>
</head>
<body>
  <div class="app">
    <!-- Mobile menu toggle -->
    <input id="menu" type="checkbox" class="menu-toggle" />

    <header class="header">
      <label for="menu" class="hamburger" aria-label="Open navigation"><span></span></label>
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>Radiator Controller</div>
      </div>
      <div class="right">
        <span class="label">Network</span>
      </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="nav">
        <div class="nav-group">
          <div class="nav-title">Main</div>
          <a href="/">Home</a>
        </div>

        <div class="nav-group">
          <div class="nav-title">Controls</div>
          <a href="/thermostat">Thermostat</a>
          <a href="/schedule">Schedule</a>
          <div class="sub">
            <a href="/summer">Summer</a>
            <a href="/winter">Winter</a>
            <a href="/brightness">Brightness</a>
          </div>
          <a href="/calibrate">Calibrate</a>
        </div>

        <div class="nav-group">
          <div class="nav-title">System</div>
          <a class="active" href="/network">Network</a>
          <a href="/settings">Settings</a>
        </div>
      </div>
    </nav>

    <!-- Backdrop for mobile menu -->
    <label for="menu" class="backdrop" aria-hidden="true"></label>

    <!-- Main -->
    <main class="main">
      <div class="settings">
        <section class="group">
          <h3>WiFi</h3>
          <div class="item">
            <div class="left">
              <div class="label">MAC address</div>
              <div class="value" id="mac-address">{{0}}</div>
            </div>
            <div class="right"></div>
          </div>
        </section>

        <section class="group">
          <h3>Network Configuration</h3>

          <form id="net-form" class="net-form">
            <!-- Toggle: DHCP ↔ Static -->
            <div class="item">
              <div class="left">
                <div class="label">IP configuration</div>
                <div class="toggle-row" aria-live="polite">
                  <span class="switch-label">DHCP</span>
                  <label class="switch">
                    <input id="modeSwitch" type="checkbox" role="switch"
                           aria-label="Toggle Static IP" aria-checked="false" />
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label">Static</span>
                </div>
              </div>
              <div class="right">
                <button type="submit" class="primary">Apply</button>
              </div>
            </div>

            <!-- Hidden field the backend reads -->
            <input type="hidden" id="mode" name="mode" value="dhcp" />

            <!-- IP Address -->
            <div class="item static-only">
              <div class="left">
                <div class="label">IP Address (Static only)</div>
                <input
                  id="ip"
                  name="ip"
                  type="text"
                  placeholder="e.g. 192.168.1.123"
                  inputmode="numeric"
                  pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$"
                  value="{{1}}"
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>
              <div class="right"></div>
            </div>

            <!-- Gateway -->
            <div class="item static-only">
              <div class="left">
                <div class="label">Gateway</div>
                <input
                  id="gateway"
                  name="gateway"
                  type="text"
                  placeholder="e.g. 192.168.1.1"
                  inputmode="numeric"
                  pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$"
                  value="{{2}}"
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>
              <div class="right"></div>
            </div>

            <!-- DNS Servers -->
            <div class="item static-only">
              <div class="left">
                <div class="label">DNS Server 1</div>
                <input
                  id="dns1"
                  name="dns1"
                  type="text"
                  placeholder="e.g. 1.1.1.1"
                  inputmode="numeric"
                  pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$"
                  value="{{3}}"
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>
              <div class="right"></div>
            </div>

            <div class="item static-only">
              <div class="left">
                <div class="label">DNS Server 2</div>
                <input
                  id="dns2"
                  name="dns2"
                  type="text"
                  placeholder="optional"
                  inputmode="numeric"
                  pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$"
                  value="{{4}}"
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>
              <div class="right"></div>
            </div>

            <div class="item static-only">
              <div class="left">
                <div class="label">DNS Server 3</div>
                <input
                  id="dns3"
                  name="dns3"
                  type="text"
                  placeholder="optional"
                  inputmode="numeric"
                  pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$"
                  value="{{5}}"
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>
              <div class="right"></div>
            </div>

            <input type="hidden" name="action" value="set_network" />
          </form>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ---- Helpers ----
    function ipv4Valid(str) {
      const m = str.match(/^((25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(25[0-5]|2[0-4]\d|[01]?\d?\d)$/);
      return !!m;
    }

    // ---- Elements ----
    const modeHidden = document.getElementById('mode');      // 'dhcp' | 'static'
    const modeSwitch = document.getElementById('modeSwitch'); // checkbox switch
    const staticInputs = Array.from(document.querySelectorAll('.static-only input'));
    const form = document.getElementById('net-form');

    // Default: DHCP
    function updateModeUI() {
      const isStatic = modeSwitch.checked;
      modeHidden.value = isStatic ? 'static' : 'dhcp';
      modeSwitch.setAttribute('aria-checked', String(isStatic));
      staticInputs.forEach(inp => { inp.disabled = !isStatic; });
    }

    // Set initial state
    modeSwitch.checked = {{6}}; // DHCP by default
    updateModeUI();

    modeSwitch.addEventListener('change', updateModeUI);

    // Keep page in place: POST via fetch with FormData
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const v = id => document.getElementById(id).value.trim();
      const [ip, gw, dns1, dns2, dns3] = [v('ip'), v('gateway'), v('dns1'), v('dns2'), v('dns3')];

      if (modeHidden.value === 'static') {
        if (!ipv4Valid(ip)) { alert('Invalid IP address'); return; } 
      }

      const body = {
        is_static: modeSwitch.checked,
        ip: ip,
        gateway: gw,
        dns1,
        dns2,
        dns3
      };

      try {
        const res = await fetch('/network', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          console.error(`POST failed: HTTP ${res.status}`);
        } else {
          console.log("Schedule posted successfully.");
        }
      } catch (err) {
        console.error("POST failed:", err);
      }

    });
  </script>
</body>
</html>
